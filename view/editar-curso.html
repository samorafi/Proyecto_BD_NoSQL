<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Editar curso</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body class="bg-light">

<header class="d-flex justify-content-between align-items-center p-3" style="background:#2a73ff;color:white;">
  <h1 class="m-0">
    <a id="homeLink" href="#" class="tituloNav" style="color:white;text-decoration:none;">Gestor Académico</a>
  </h1>
  <div class="d-flex align-items-center gap-2">
    <span id="userInfo" class="badge rounded-pill bg-light text-dark" style="display:none;"></span>
    <button id="logoutBtn" class="btn btn-light btn-sm" style="display:none;">Salir</button>
  </div>
</header>

<nav id="mainNav">
  <ul class="menu">
    <li><a href="/perfil.html">Perfil</a></li>
    <li><a href="/gestion-academica.html">Gestión Académica</a></li>
    <li><a href="/menu-tareas.html">Tareas y Colaboración</a></li>
    <li><a href="#">Estadísticas</a></li>
    <li><a href="#">Logs</a></li>
  </ul>
</nav>

<main class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="text-primary m-0">Editar curso</h2>
    <a href="/cursos.html" class="btn btn-outline-secondary btn-sm">← Volver</a>
  </div>

  <div id="alertBox" class="alert d-none" role="alert"></div>

  <div class="card shadow-sm">
    <div class="card-body">
      <form id="cursoForm" class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Carrera</label>
          <select id="selCarrera" class="form-select" required>
            <option value="">Seleccione…</option>
          </select>
          <div class="form-text">Se cargan desde la colección "carreras".</div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Código</label>
          <input id="inpCodigo" class="form-control" placeholder="CUR-001" required/>
        </div>

        <div class="col-12">
          <label class="form-label">Curso (nombre)</label>
          <input id="inpNombre" class="form-control" placeholder="Programación Web" required/>
        </div>

        <div class="col-md-6">
          <label class="form-label">Profesor</label>
          <select id="selProfesor" class="form-select" required>
            <option value="">Seleccione…</option>
          </select>
          <div class="form-text">Lista de usuarios con rol Profesor.</div>
        </div>

        <div class="col-12 mt-2 d-flex gap-2">
          <button class="btn btn-primary" id="btnGuardar">Guardar cambios</button>
          <button type="button" class="btn btn-outline-danger ms-auto" id="btnEliminar">Eliminar curso</button>
        </div>
      </form>
    </div>
  </div>
</main>

<script>
  // ===== Utils =====
  function qs(name){ return new URLSearchParams(location.search).get(name); }
  function cap(s){ return s ? s.charAt(0).toUpperCase()+s.slice(1) : ''; }
  function showAlert(msg, type='danger'){ const box=document.getElementById('alertBox'); box.textContent=msg||'Ocurrió un error'; box.className='alert alert-'+type; }
  function hideAlert(){ document.getElementById('alertBox').className='alert d-none'; }
  const norm = s => (s||'').toString().trim().toLowerCase()
                     .normalize('NFD').replace(/[\u0300-\u036f]/g, '');

  function setSelectedByText(selectEl, text){
    if(!selectEl) return;
    const target = norm(text);
    for(const opt of selectEl.options){
      if(norm(opt.text) === target){ selectEl.value = opt.value; return; }
    }
  }

  // ===== API =====
  async function getMe(){ const r=await fetch('/api/auth/me'); if(!r.ok) throw new Error('No autenticado'); return r.json(); }
  async function getCurso(id){ const r=await fetch('/api/cursos/'+encodeURIComponent(id)); if(!r.ok) throw new Error(await r.text()); return r.json(); }

  async function updateCurso(id,payload){
    const r=await fetch('/api/cursos/'+encodeURIComponent(id),{
      method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
    });
    if(!r.ok) throw new Error(await r.text());
    return r.json();
  }

  async function deleteCurso(id){
    const r=await fetch('/api/cursos/'+encodeURIComponent(id),{ method:'DELETE' });
    if(!r.ok) throw new Error(await r.text());
    return r.json();
  }

  async function loadCarreras(){
    // Intenta /api/carreras; si no existe, prueba /api/academico/carreras (por si ya lo tienes).
    let resp = await fetch('/api/carreras').catch(()=>null);
    if(!resp || !resp.ok) resp = await fetch('/api/academico/carreras').catch(()=>null);

    let carreras = [];
    if(resp && resp.ok){
      const data = await resp.json();
      // Acepta { carreras: [...] } o un array directo
      carreras = Array.isArray(data?.carreras) ? data.carreras : (Array.isArray(data) ? data : []);
    }

    const sel = document.getElementById('selCarrera');
    sel.innerHTML = '<option value="">Seleccione…</option>' + (carreras||[]).map(c => {
      // c puede traer { _id, nombre, codigo }. Guardamos el nombre como value (porque el curso guarda string).
      const nombre = c.nombre || c.name || c.codigo || c._id || '—';
      return `<option value="${nombre}">${nombre}</option>`;
    }).join('');
  }

  async function loadProfesores(){
    // Intenta /api/users?rol=profesor; como fallback intenta /api/admin?rol=profesor
    let r = await fetch('/api/users?rol=profesor').catch(()=>null);
    if(!r || !r.ok) r = await fetch('/api/admin?rol=profesor').catch(()=>null);

    let usuarios = [];
    if(r && r.ok){
      const data = await r.json();
      usuarios = Array.isArray(data?.users) ? data.users : (Array.isArray(data) ? data : []);
    }

    const sel = document.getElementById('selProfesor');
    sel.innerHTML = '<option value="">Seleccione…</option>' + (usuarios||[]).map(u => {
      const label = u.nombre || u.correo || u.email || u._id;
      return `<option value="${u._id}">${label}</option>`;
    }).join('');
    return usuarios;
  }

  (async ()=>{
    try{
      const id = qs('id');
      if(!id){ showAlert('Falta el parámetro id del curso'); return; }

      // Auth + rol admin
      const me = await getMe();
      const user = me.user || {};
      const rol  = (user.rolNombre || '').toLowerCase();
      if(rol !== 'administrador'){ window.location.href = '/dashboard'; return; }

      // Header
      const home = '/index-admin.html';
      document.getElementById('homeLink').href = home;
      const info = document.getElementById('userInfo'); info.textContent = `${user.nombre} · ${cap(rol)}`; info.style.display = 'inline-flex';
      const logout = document.getElementById('logoutBtn'); logout.style.display='inline-block';
      logout.onclick = async ()=>{ try{ await fetch('/api/auth/logout', { method:'POST' }); }catch{} window.location.href='/login.html'; };

      // Carga catálogos
      await loadCarreras();
      const profesores = await loadProfesores();

      // Cargar curso
      const curso = await getCurso(id);
      // Rellena campos
      document.getElementById('inpCodigo').value = curso.codigo || '';
      document.getElementById('inpNombre').value = curso.nombre || '';

      // Preseleccionar carrera por nombre (texto)
      setSelectedByText(document.getElementById('selCarrera'), curso.carrera || '');

      // Preseleccionar profesor:
      // 1) Si tu endpoint /api/cursos/:id devuelve profesor_id (ideal)
      if(curso.profesor_id){
        document.getElementById('selProfesor').value = curso.profesor_id;
      }else if(curso.profesor){
        // 2) Fallback: intenta empatar por nombre del profesor
        setSelectedByText(document.getElementById('selProfesor'), curso.profesor);
      }

      // Guardar
      document.getElementById('cursoForm').addEventListener('submit', async (e)=>{
        e.preventDefault(); hideAlert();

        const selCarr = document.getElementById('selCarrera');
        const selProf = document.getElementById('selProfesor');

        const payload = {
          carrera: selCarr.value || (selCarr.options[selCarr.selectedIndex]?.text || '').trim(),
          codigo:  (document.getElementById('inpCodigo').value || '').trim(),
          nombre:  (document.getElementById('inpNombre').value || '').trim(),
          profesor_id: selProf.value || undefined
        };

        if(!payload.carrera || !payload.codigo || !payload.nombre || !payload.profesor_id){
          showAlert('Complete todos los campos obligatorios'); return;
        }

        try{
          await updateCurso(id, payload);
          showAlert('Cambios guardados', 'success');
          setTimeout(()=>location.href='/cursos.html', 800);
        }catch(err){
          showAlert('No se pudo guardar. '+(err.message || err));
        }
      });

      // Eliminar
      document.getElementById('btnEliminar').addEventListener('click', async ()=>{
        if(!confirm('¿Eliminar este curso?')) return;
        try{
          await deleteCurso(id);
          showAlert('Curso eliminado', 'success');
          setTimeout(()=>location.href='/cursos.html', 600);
        }catch(err){
          showAlert('No se pudo eliminar. '+(err.message || err));
        }
      });

    }catch(e){
      window.location.href = '/login.html';
    }
  })();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
