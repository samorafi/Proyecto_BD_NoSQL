<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Editar curso</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="css/styles.css">
  <style> header{background:#2a73ff;color:white;} </style>
</head>
<body class="bg-light">

<header class="d-flex justify-content-between align-items-center p-3">
  <h1 class="m-0">
    <a id="homeLink" href="#" class="tituloNav" style="color:white;text-decoration:none;">Gestor Académico</a>
  </h1>
  <div class="d-flex align-items-center gap-2">
    <span id="userInfo" class="badge rounded-pill bg-light text-dark" style="display:none;"></span>
    <button id="logoutBtn" class="btn btn-light btn-sm" style="display:none;">Salir</button>
  </div>
</header>

<nav id="mainNav">
  <ul class="menu">
    <li><a href="/perfil.html">Perfil</a></li>
    <li><a href="/gestion-academica.html">Gestión Académica</a></li>
    <li><a href="/menu-tareas.html">Tareas y Colaboración</a></li>
    <li><a href="#">Estadísticas</a></li>
    <li><a href="#">Logs</a></li>
    <li><a href="/admin-usuarios.html" class="selectedNav">Gestión de Usuarios</a></li>
  </ul>
</nav>

<main class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="text-primary m-0">Editar curso</h2>
    <a href="/cursos.html" class="btn btn-outline-secondary btn-sm">← Volver</a>
  </div>

  <div id="alertBox" class="alert d-none" role="alert"></div>

  <div class="card shadow-sm">
    <div class="card-body">
      <form id="cursoForm" class="row g-3">
        <!-- Carrera -->
        <div class="col-md-6">
          <label class="form-label">Carrera</label>
          <select id="selCarrera" class="form-select" required>
            <option value="">Cargando carreras…</option>
          </select>
        </div>

        <!-- Nombre del curso -->
        <div class="col-12">
          <label class="form-label">Curso (nombre)</label>
          <input id="inpNombre" class="form-control" placeholder="Programación Web" required/>
        </div>

        <div class="col-md-6">
          <label class="form-label">Profesor</label>
          <select id="selProfesor" class="form-select" required>
            <option value="">Seleccione primero una carrera…</option>
          </select>
        </div>

        <div class="col-12 mt-2 d-flex gap-2">
          <button class="btn btn-primary" id="btnGuardar">Guardar cambios</button>
          <button type="button" class="btn btn-outline-danger ms-auto" id="btnEliminar">Eliminar curso</button>
        </div>
      </form>
    </div>
  </div>
</main>

<script>
  // ===== Utils =====
  const $ = (id)=>document.getElementById(id);
  const cap = (s)=> s? s.charAt(0).toUpperCase() + s.slice(1) : '';
  const qs = (k)=> new URLSearchParams(location.search).get(k);

  function showAlert(msg, type='danger'){ const b=$('alertBox'); b.textContent=msg||'Ocurrió un error'; b.className='alert alert-'+type; }
  function hideAlert(){ $('alertBox').className='alert d-none'; }

  const norm = s => (s||'').toString().trim().toLowerCase()
                   .normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  function setSelectedByText(selectEl, text){
    if(!selectEl) return;
    const t = norm(text);
    for(const opt of selectEl.options){
      if(norm(opt.text) === t){ selectEl.value = opt.value; return; }
    }
  }

  // ===== API =====
  async function getMe(){
    const r = await fetch('/api/auth/me', { credentials:'include' });
    if(!r.ok) throw new Error('No autenticado');
    return r.json();
  }

  async function getCurso(id){
    const r = await fetch('/api/cursos/'+encodeURIComponent(id), { credentials:'include' });
    if(!r.ok){
      let txt=''; try{ txt = await r.text(); }catch{}
      throw new Error(txt || 'No se pudo cargar el curso');
    }
    return r.json();
  }

  async function updateCurso(id, payload){
    const r = await fetch('/api/cursos/'+encodeURIComponent(id),{
      method:'PUT',
      headers:{ 'Content-Type':'application/json' },
      credentials:'include',
      body: JSON.stringify(payload)
    });
    if(!r.ok){
      let txt=''; try{ txt = await r.text(); }catch{}
      throw new Error(txt || 'No se pudo guardar');
    }
    return r.json();
  }

  async function deleteCurso(id){
    const r = await fetch('/api/cursos/'+encodeURIComponent(id),{
      method:'DELETE',
      credentials:'include'
    });
    if(!r.ok){
      let txt=''; try{ txt = await r.text(); }catch{}
      throw new Error(txt || 'No se pudo eliminar');
    }
    return r.json();
  }

  async function loadCarreras(preselectedId){
    const sel = $('selCarrera');
    try{
      const res = await fetch('/api/cursos/carreras', { credentials:'include' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const { carreras } = await res.json();
      if(!Array.isArray(carreras) || carreras.length===0){
        sel.innerHTML = '<option value="">No hay carreras</option>'; sel.disabled = true; return [];
      }
      sel.innerHTML = '<option value="">Seleccione…</option>' + carreras.map(c =>
        `<option value="${c._id}">${c.nombre}</option>`
      ).join('');
      sel.disabled = false;
      if(preselectedId) sel.value = preselectedId;
      return carreras;
    }catch(e){
      console.error('Error cargando carreras:', e);
      sel.innerHTML = '<option value="">No se pudieron cargar las carreras</option>'; sel.disabled = true;
      return [];
    }
  }

  async function loadProfesores(carrera_id, preselectedId){
    const sel = $('selProfesor');
    if(!carrera_id){
      sel.innerHTML = '<option value="">Seleccione primero una carrera…</option>'; sel.disabled = true; return [];
    }
    try{
      const r = await fetch(`/api/cursos/profes?carrera_id=${encodeURIComponent(carrera_id)}`, { credentials:'include' });
      if(!r.ok) throw new Error('HTTP '+r.status);
      const { profesores } = await r.json();
      if(!Array.isArray(profesores) || profesores.length===0){
        sel.innerHTML = '<option value="">No hay profesores para esta carrera</option>'; sel.disabled = true; return [];
      }
      sel.innerHTML = '<option value="">Seleccione…</option>' + profesores.map(p =>
        `<option value="${p._id}">${p.nombre}${p.carrera ? ' — '+p.carrera : ''}</option>`
      ).join('');
      sel.disabled = false;
      if(preselectedId) sel.value = preselectedId;
      return profesores;
    }catch(e){
      console.error('Error cargando profesores:', e);
      sel.innerHTML = '<option value="">No se pudieron cargar los profesores</option>'; sel.disabled = true;
      return [];
    }
  }

  (async ()=>{
    try{
      const id = qs('id');
      if(!id){ showAlert('Falta el parámetro id del curso'); return; }

      // Auth + rol admin
      const me = await getMe();
      const user = me.user || {};
      const rol  = (user.rolNombre||'').toLowerCase();
      if(rol !== 'administrador'){ location.href='/dashboard'; return; }

      // Header
      $('homeLink').href = '/index-admin.html';
      const info=$('userInfo'); info.textContent=`${user.nombre} · ${cap(rol)}`; info.style.display='inline-flex';
      const logout=$('logoutBtn'); logout.style.display='inline-block';
      logout.onclick = async ()=>{ try{ await fetch('/api/auth/logout',{method:'POST',credentials:'include'}); }catch{} location.href='/login.html'; };

      // 1) Cargar el curso
      const curso = await getCurso(id);
      // Soportar variantes del backend
      const cursoNombre     = curso.nombre || '';
      const cursoCarreraId  = curso.carrera_id || curso.carreraId || null;
      const cursoCarreraTxt = curso.carrera || curso.carreraNombre || '';
      const cursoProfesorId = curso.profesor_id || curso.profesorId || null;
      const cursoProfesorTx = curso.profesor || '';

      // 2) Cargar carreras y preseleccionar
      const carreras = await loadCarreras(cursoCarreraId);
      if(!cursoCarreraId && cursoCarreraTxt){
        // si no vino el id, intenta seleccionar por texto
        setSelectedByText($('selCarrera'), cursoCarreraTxt);
      }

      // 3) Cargar profesores para la carrera seleccionada y preseleccionar
      const carreraSeleccionada = $('selCarrera').value;
      await loadProfesores(carreraSeleccionada, cursoProfesorId);
      if(!cursoProfesorId && cursoProfesorTx){
        setSelectedByText($('selProfesor'), cursoProfesorTx);
      }

      // 4) Rellenar nombre
      $('inpNombre').value = cursoNombre;

      // 5) Al cambiar carrera, recargar profesores
      $('selCarrera').addEventListener('change', (e)=>{
        loadProfesores(e.target.value);
      });

      // 6) Guardar cambios
      $('cursoForm').addEventListener('submit', async (e)=>{
        e.preventDefault(); hideAlert();
        const payload = {
          nombre:      ($('inpNombre').value||'').trim(),
          carrera_id:  $('selCarrera').value,
          profesor_id: $('selProfesor').value
        };
        if(!payload.nombre || !payload.carrera_id || !payload.profesor_id){
          showAlert('Complete todos los campos obligatorios'); return;
        }
        try{
          await updateCurso(id, payload);
          showAlert('Cambios guardados','success');
          setTimeout(()=>location.href='/cursos.html',800);
        }catch(err){
          showAlert(err.message||'No se pudo guardar');
        }
      });

      // 7) Eliminar curso
      $('btnEliminar').addEventListener('click', async ()=>{
        if(!confirm('¿Eliminar este curso?')) return;
        try{
          await deleteCurso(id);
          showAlert('Curso eliminado','success');
          setTimeout(()=>location.href='/cursos.html',600);
        }catch(err){
          showAlert(err.message||'No se pudo eliminar');
        }
      });

    }catch(e){
      console.error(e);
      location.href='/login.html';
    }
  })();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/auth-ui.js"></script>
<script>
  AuthUI.initHeader({ protect: true });
</script>
</body>
</html>
