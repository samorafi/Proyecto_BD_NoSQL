<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Men√∫ de Tareas y Colaboraci√≥n</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="css/styles.css">
</head>

<body class="bg-light">

  <header class="d-flex justify-content-between align-items-center p-3" style="background:#2a73ff; color:white;">
    <h1 class="m-0">
      <a href="#" id="homeLink" class="tituloNav" style="color:white; text-decoration:none;">Gestor Acad√©mico</a>
    </h1>
    <div class="d-flex align-items-center gap-2">
      <span id="userInfo" class="badge rounded-pill bg-light text-dark" style="display:none;"></span>
      <button id="logoutBtn" class="btn btn-light btn-sm" style="display:none;">Salir</button>
    </div>
  </header>


  <nav id="mainNav">
    <ul class="menu">
      <li><a href="/perfil.html">Perfil</a></li>
      <li><a href="/gestion-academica.html">Gesti√≥n Acad√©mica</a></li>
      <li><a href="menu-tareas.html" class="selectedNav">Tareas y Colaboraci√≥n</a></li>
      <li><a href="estadisticas.html">Estad√≠sticas</a></li>
      <li><a href="logs.html">Logs</a></li>
      <li class="role-only" data-roles="administrador" style="display:none;"><a href="/admin-usuarios.html">Gesti√≥n de Usuarios</a>
    </ul>
  </nav>

  <main>
    <div class="container py-5">
      <h2 class="text-center mb-4 text-primary">Panel de Tareas y Colaboraci√≥n</h2>
      <div class="row g-4">

        <!-- Todas las tareas (profesor, administrador) -->
        <div class="col-sm-6 col-md-4 card-role" data-roles="profesor,administrador">
          <a href="/tareas.html" class="text-decoration-none text-dark">
            <div class="card bento-card shadow-sm h-100">
              <div class="card-body text-center">
                <div class="bento-icon">üìã</div>
                <h5 class="card-title mt-2">Todas las tareas</h5>
                <p class="card-text small">Visualiza todas las tareas creadas en el sistema.</p>
              </div>
            </div>
          </a>
        </div>

        <!-- Mis tareas (todos) -->
        <div class="col-sm-6 col-md-4 card-role" data-roles="estudiante,profesor,administrador">
          <a href="/mis-tareas.html" class="text-decoration-none text-dark">
            <div class="card bento-card shadow-sm h-100">
              <div class="card-body text-center">
                <div class="bento-icon">‚úÖ</div>
                <h5 class="card-title mt-2">Mis tareas</h5>
                <p class="card-text small">Consulta y gestiona las tareas asignadas a ti.</p>
              </div>
            </div>
          </a>
        </div>

        <!-- Crear tarea (profesor,administrador) -->
        <div class="col-sm-6 col-md-4 card-role" data-roles="profesor,administrador">
          <a href="/crear-tarea.html" class="text-decoration-none text-dark">
            <div class="card bento-card shadow-sm h-100">
              <div class="card-body text-center">
                <div class="bento-icon">‚ûï</div>
                <h5 class="card-title mt-2">Crear tarea</h5>
                <p class="card-text small">Registra nuevas tareas en el sistema.</p>
              </div>
            </div>
          </a>
        </div>

        <!-- Etiquetas (profesor, administrador) -->
        <div class="col-sm-6 col-md-4 card-role" data-roles="profesor,administrador">
          <a href="etiquetas.html" class="text-decoration-none text-dark">
            <div class="card bento-card shadow-sm h-100">
              <div class="card-body text-center">
                <div class="bento-icon">üè∑Ô∏è</div>
                <h5 class="card-title mt-2">Etiquetas</h5>
                <p class="card-text small">Administra etiquetas utilizadas en las tareas.</p>
              </div>
            </div>
          </a>
        </div>

      </div>
    </div>
  </main>

  <script>
    async function initPage() {
      try {
        const res = await fetch('/api/auth/me');
        if (!res.ok) {
          // No hay sesi√≥n ‚Üí al login
          return window.location.replace('/login.html');
        }
        const { user } = await res.json();
        const rol = (user && user.rolNombre) || 'estudiante';

        // Mostrar header logout y nav/main
        document.getElementById('logoutBtn').style.display = 'inline-block';
        document.querySelector('nav').style.display = 'block';
        document.querySelector('main').style.display = 'block';

        // Filtrar tarjetas por rol
        document.querySelectorAll('.card-role').forEach(card => {
          const roles = (card.getAttribute('data-roles') || '').split(',').map(r => r.trim());
          if (!roles.includes(rol)) {
            card.style.display = 'none';
          }
        });
      } catch (err) {
        console.error('Error verificando sesi√≥n:', err);
        window.location.replace('/login.html');
      }
    }

    async function initHeader() {
      try {
        const res = await fetch('/api/auth/me');
        if (!res.ok) return;
        const { user } = await res.json();
        const rol = (user && user.rolNombre) || 'estudiante';

        // Definir p√°gina de inicio por rol
        let homeUrl = '/index-estudiante.html';
        if (rol === 'profesor') homeUrl = '/index-profesor.html';
        if (rol === 'administrador') homeUrl = '/index-admin.html';

        // Ajustar href din√°micamente
        document.getElementById('homeLink').setAttribute('href', homeUrl);

        // Mostrar bot√≥n de salir
        document.getElementById('logoutBtn').style.display = 'inline-block';
      } catch (err) {
        console.error('Error obteniendo rol:', err);
      }
    }

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        await fetch('/api/auth/logout', { method: 'POST' });
        window.location.href = '/login.html';
      } catch (e) {
        console.error('Error cerrando sesi√≥n:', e);
      }
    });

    function cap(s) { return s ? s.charAt(0).toUpperCase() + s.slice(1) : ''; }

    (async () => {
      try {
        const res = await fetch('/api/auth/me');
        if (!res.ok) { window.location.href = '/login.html'; return; }
        const { user } = await res.json();

        const rol = user?.rolNombre || 'estudiante';
        const home =
          rol === 'profesor' ? '/index-profesor.html' :
            rol === 'administrador' ? '/index-admin.html' :
              '/index-estudiante.html';

        const homeLink = document.getElementById('homeLink');
        if (homeLink) homeLink.href = home;

        const info = document.getElementById('userInfo');
        if (info) {
          info.textContent = `${user.nombre} ¬∑ ${cap(rol)}`;
          info.style.display = 'inline-flex';
        }

        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
          logoutBtn.style.display = 'inline-block';
          logoutBtn.addEventListener('click', async () => {
            await fetch('/api/auth/logout', { method: 'POST' });
            window.location.href = '/login.html';
          });
        }
      } catch (e) {
        window.location.href = '/login.html';
      }
    })();

    initPage();
    initHeader();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/auth-ui.js"></script>
  <script>
    AuthUI.initHeader({ protect: true });
  </script>
</body>

</html>