<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Etiquetas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body class="bg-light">

  <!-- Header -->
  <header class="d-flex justify-content-between align-items-center p-3" style="background:#2a73ff; color:white;">
    <h1 class="m-0">
      <a href="#" id="homeLink" class="tituloNav" style="color:white; text-decoration:none;">Gestor Académico</a>
    </h1>
    <div class="d-flex align-items-center gap-2">
      <span id="userInfo" class="badge rounded-pill bg-light text-dark" style="display:none;"></span>
      <button id="logoutBtn" class="btn btn-light btn-sm" style="display:none;">Salir</button>
    </div>
  </header>

  <!-- Nav -->
  <nav id="mainNav">
    <ul class="menu">
      <li><a href="/perfil.html">Perfil</a></li>
      <li><a href="gestion-academica.html">Gestión Académica</a></li>
      <li><a href="/menu-tareas.html">Tareas y Colaboración</a></li>
      <li><a href="estadisticas.html">Estadísticas</a></li>
      <li><a href="logs.html">Logs</a></li>
      <li class="role-only" data-roles="administrador" style="display:none;">
        <a href="/admin-usuarios.html">Gestión de Usuarios</a>
      </li>
    </ul>
  </nav>

  <!-- Main -->
  <main class="container py-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
      <h2 class="text-primary m-0">Etiquetas</h2>
    </div>

    <div id="alertBox" class="alert alert-danger d-none" role="alert"></div>

    <div class="card shadow-sm">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>id</th>
                <th>Nombre</th>
                <th>Color</th>
                <th id="thAcciones" style="width:170px;">Acciones</th>
              </tr>
            </thead>
            <tbody id="etiquetas-table"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Script -->
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const tbody = document.getElementById("etiquetas-table");

      try {
        const res = await fetch("/api/etiquetas");
        const etiquetas = await res.json();

        tbody.innerHTML = "";

        etiquetas.forEach(etiqueta => {
          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>${etiqueta._id}</td>
            <td>${etiqueta.nombre || ""}</td>
            <td>${etiqueta.color || ""}</td>
            <td>
              <button class="btn btn-sm btn-danger">Eliminar</button>
            </td>
          `;
          //Para el boton de eliminar
          const deleteBtn = tr.querySelector(".btn-danger");
          deleteBtn.addEventListener("click", async () => {
            if (!confirm("¿Seguro que quieres eliminar esta estadística?")) return;

            try {
              const res = await fetch(`/api/etiquetas/${etiqueta._id}`, {
                method: "DELETE"
              });

              if (res.ok) {
                tr.remove();
              } else {
                alert("Error al eliminar");
              }
            } catch (err) {
              console.error("Error eliminando:", err);
              alert("Error de conexión al eliminar");
            }
          });
          tbody.appendChild(tr);
        });
      } catch (error) {
        console.error("Error cargando etiquetas:", error);
        document.getElementById("alertBox").classList.remove("d-none");
        document.getElementById("alertBox").textContent = "No se pudieron cargar los etiquetas";
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/auth-ui.js"></script>
  <script> AuthUI?.initHeader?.({ protect:true }); </script>
</body>
</html>
