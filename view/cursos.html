<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Listado de Cursos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body class="bg-light">

  <header class="d-flex justify-content-between align-items-center p-3" style="background:#2a73ff; color:white;">
    <h1 class="m-0">
      <a href="#" id="homeLink" class="tituloNav" style="color:white; text-decoration:none;">Gestor Académico</a>
    </h1>
    <div class="d-flex align-items-center gap-2">
      <span id="userInfo" class="badge rounded-pill bg-light text-dark" style="display:none;"></span>
      <button id="logoutBtn" class="btn btn-light btn-sm" style="display:none;">Salir</button>
    </div>
  </header>

  <nav id="mainNav">
    <ul class="menu">
      <li><a href="/perfil.html">Perfil</a></li>
      <li><a href="/gestion-academica.html">Gestión Académica</a></li>
      <li><a href="/menu-tareas.html">Tareas y Colaboración</a></li>
      <li><a href="#">Estadísticas</a></li>
      <li><a href="#">Logs</a></li>
    </ul>
  </nav>

  <main class="container py-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
      <h2 class="text-primary m-0">Listado de Cursos</h2>
      <div class="d-flex gap-2">
        <a id="btnCrear" href="/crear-curso.html" class="btn btn-primary btn-sm" style="display:none;">+ Crear curso</a>
        <button id="btnRefrescar" class="btn btn-outline-secondary btn-sm">Actualizar</button>
      </div>
    </div>

    <div id="alertBox" class="alert alert-danger d-none" role="alert"></div>

    <div class="card shadow-sm">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th style="width:120px">Código</th>
                <th>Curso</th>
                <th style="width:240px">Profesor</th>
                <th id="thAcciones" style="width:170px; display:none;">Acciones</th>
              </tr>
            </thead>
            <tbody id="tbodyCursos">
              <tr><td colspan="4">Cargando...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script>
    function cap(s){ return s ? s.charAt(0).toUpperCase()+s.slice(1) : ''; }
    function showAlert(msg){
      const box = document.getElementById('alertBox');
      if(!box) return;
      box.textContent = msg || 'Ocurrió un error';
      box.classList.remove('d-none');
    }
    function hideAlert(){
      const box = document.getElementById('alertBox');
      if(!box) return;
      box.classList.add('d-none');
    }

    async function getMe(){
      const r = await fetch('/api/auth/me');
      if(!r.ok) throw new Error('No autenticado');
      return r.json();
    }
    async function getCursosPorRol(){
      const r = await fetch('/api/cursos/listado-por-rol');
      if(!r.ok){
        const txt = await r.text().catch(()=> '');
        throw new Error(txt || 'No se pudo cargar el listado');
      }
      return r.json();
    }
    async function eliminarCurso(id){
      const r = await fetch('/api/cursos/' + encodeURIComponent(id), { method:'DELETE' });
      if(!r.ok){
        const txt = await r.text().catch(()=> '');
        throw new Error(txt || 'No se pudo eliminar');
      }
      return r.json();
    }

    function renderTabla(payload){
      hideAlert();
      const { canEdit, canDelete, cursos } = payload || {};
      const tbody = document.getElementById('tbodyCursos');
      const thAcc = document.getElementById('thAcciones');
      const btnCrear = document.getElementById('btnCrear');

      const showActions = !!(canEdit || canDelete);
      if(thAcc) thAcc.style.display = showActions ? '' : 'none';
      if(btnCrear) btnCrear.style.display = showActions ? 'inline-block' : 'none';

      if(!tbody) return;
      const list = Array.isArray(cursos) ? cursos : [];
      if(list.length === 0){
        tbody.innerHTML = `<tr><td colspan="${showActions?4:3}" class="text-muted">Sin cursos para mostrar.</td></tr>`;
        return;
      }

      tbody.innerHTML = list.map(c => {
        const acciones = showActions ? `
          <td>
            <div class="btn-group btn-group-sm">
              <a class="btn btn-outline-primary" href="/editar-curso.html?id=${encodeURIComponent(c.id)}">Editar</a>
              <button class="btn btn-outline-danger" data-id="${c.id}" onclick="borrarCurso(this)">Eliminar</button>
            </div>
          </td>` : '';

        return `
          <tr>
            <td>${(c.codigo ?? '—')}</td>
            <td>${(c.nombre ?? '—')}</td>
            <td>${(c.profesor ?? '—')}</td>
            ${acciones}
          </tr>`;
      }).join('');
    }

    async function cargarCursos(){
      const tbody = document.getElementById('tbodyCursos');
      if(tbody) tbody.innerHTML = `<tr><td colspan="4">Cargando...</td></tr>`;
      try{
        const data = await getCursosPorRol();
        renderTabla(data);
      }catch(err){
        console.error('Error cargando cursos:', err);
        showAlert('No se pudieron cargar los cursos. Detalle: ' + (err.message || err));
        if(tbody) tbody.innerHTML = `<tr><td colspan="4" class="text-danger">No se pudieron cargar los cursos.</td></tr>`;
      }
    }

    async function borrarCurso(btn){
      const id = btn?.getAttribute('data-id');
      if(!id) return;
      if(!confirm('¿Eliminar este curso?')) return;
      try{
        await eliminarCurso(id);
        await cargarCursos();
      }catch(err){
        console.error('Error eliminando curso:', err);
        showAlert('No se pudo eliminar el curso. Detalle: ' + (err.message || err));
      }
    }
    window.borrarCurso = borrarCurso;

    (async () => {
      try {
        const me = await getMe(); // si falla, sí va a login
        const user = me.user || {};
        const rol  = (user.rolNombre || 'estudiante');
        const home = rol==='profesor' ? '/index-profesor.html'
                    : rol==='administrador' ? '/index-admin.html'
                    : '/index-estudiante.html';

        const info = document.getElementById('userInfo');
        if(info){ info.textContent = `${user.nombre} · ${cap(rol)}`; info.style.display = 'inline-flex'; }
        const logout = document.getElementById('logoutBtn');
        if(logout){
          logout.style.display = 'inline-block';
          logout.addEventListener('click', async ()=>{
            try { await fetch('/api/auth/logout', { method:'POST' }); } catch(_) {}
            window.location.href = '/login.html';
          });
        }
        const homeLink = document.getElementById('homeLink'); if(homeLink) homeLink.href = home;

        await cargarCursos();
        const btnRefrescar = document.getElementById('btnRefrescar');
        if(btnRefrescar) btnRefrescar.addEventListener('click', cargarCursos);

      } catch (e) {
        window.location.href = '/login.html';
      }
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/auth-ui.js"></script>
  <script> AuthUI?.initHeader?.({ protect:true }); </script>
</body>
</html>
